# .gitlab-ci.yml

# image: node:22.15.0-slim # å…¨å±€é•œåƒï¼Œä½¿ç”¨å…·ä½“çš„nodejsç‰ˆæœ¬é•œåƒ,é¿å…æ­§ä¹‰

# å®šä¹‰æµæ°´çº¿é˜¶æ®µ
stages:
    - build
    - test
    - document
    - publish

build_job:
    tags:
        - fe  # æ‰§è¡Œjobçš„ runner,runnerä¸­å®šä¹‰tag æ¥åŒ¹é…
    stage: build
    script:
        - echo "æ„å»ºé¡¹ç›®..."
        - echo "ğŸ”§ æ­£åœ¨å®‰è£…ä¾èµ– (ç¦»çº¿æ¨¡å¼)..."
        # ç¦»çº¿å®‰è£…æ¨¡å¼ï¼ˆä¸¥æ ¼ä¾èµ–æœ¬åœ°ç¼“å­˜ï¼‰
        - npm i
        - echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
        # - npm run build
        - echo "âœ… æ„å»ºå®Œæˆ"
    cache:
        paths:
            - node_modules/
    # artifacts:
    #     when: on_success # å‰é¢é˜¶æ®µä¸­çš„æ‰€æœ‰ä½œä¸šéƒ½æˆåŠŸæ—¶æ‰æ‰§è¡Œ
    #     paths:
    #         - dist/
    rules:
        - if: $CI_COMMIT_BRANCH == "main"

# test_job:
    # tags:
    #     - fe
#     stage: test
#     script:
#         - echo "è¿è¡Œæµ‹è¯•..."
#         - npm run test
#     dependencies:
#         - build
#     cache:
#         paths:
#             - coverage/
#     artifacts:
#         # åœ¨æ„å»ºæˆåŠŸåï¼Œè¿è¡Œæµ‹è¯•è„šæœ¬ï¼Œå¹¶ä¸”å®šä¹‰äº†æµ‹è¯•è¦†ç›–ç‡çš„ç¼“å­˜å’Œæ„ä»¶ã€‚
#         expire_in: 1 days
#         when: on_success
#         paths:
#             - coverage/

# document_job:
    # tags:
    #     - fe
#     # åœ¨æ„å»ºæˆåŠŸåï¼Œå°†docs/ç›®å½•ä¸‹çš„æ–‡ä»¶å¤åˆ¶åˆ°.publicç›®å½•ï¼Œå¹¶å°†.publicç›®å½•é‡å‘½åä¸ºpublicï¼Œ
#     # å°† public ç›®å½•ä½œä¸ºæ„ä»¶ä¿å­˜ã€‚è¿™ä¸ªä»»åŠ¡åªåœ¨ master åˆ†æ”¯å’Œæ ‡ç­¾ä¸Šæ‰§è¡Œ
#     stage: document
#     dependencies:
#         - build
#     script:
#         - echo "ç”Ÿæˆæ–‡æ¡£..."
#         - mkdir .public
#         - cp -r docs/* .public
#         - mv .public public
#     artifacts:
#         paths:
#             - public
#   rules:
#     - if: $CI_COMMIT_BRANCH == "main"
#     - if: $CI_COMMIT_TAG

# å‘å¸ƒåˆ° GitLab NPM Registry
publish_job:
    tags:
        - fe
    stage: publish
    variables:
        # NPM_TOKEN: gldt-TBYaCo1VGsCZKeW4rxSh # privite-npm åŒ…é¡¹ç›®çš„éƒ¨ç½² tokenï¼Œå‘å¸ƒæ—¶è®¤è¯ç”¨
        NPM_TOKEN: ${NPM_TOKEN}
    script:
        # åŠ¨æ€ç”Ÿæˆ .npmrc æ–‡ä»¶
        - echo "å‘å¸ƒ..."
        - npm publish
        - echo "âœ… æˆåŠŸå‘å¸ƒåˆ°å†…ç½‘ä»“åº“"
    dependencies:
        - build_job
        # - test
    rules:
        - if: $CI_COMMIT_BRANCH == "main"
        - if: $CI_COMMIT_TAG
