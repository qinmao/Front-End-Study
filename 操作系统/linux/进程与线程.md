# 进程与线程
进程（Process）和线程（Thread）是操作系统中管理任务执行的两个重要概念。理解它们的区别和关系，有助于更好地掌握操作系统的工作原理和并发编程。

## 并发与并行
* 并发 (Concurrent) = 2 队列对应 1 咖啡机, 并行 (Parallel) = 2 队列对应 2 咖啡机.
* Node.js 通过事件循环来挨个抽取事件队列中的一个个 Task 执行, 从而避免了传统的多线程情况下 2个队列对应 1个咖啡机 的时候上下文切换以及资源争抢/同步的问题, 所以获得了高并发的成就.

## 进程（Process）
* 概念
  - 进程是操作系统进行资源管理和调度的基本单位，它是程序在计算机上执行时的实例
  - 每个进程都有自己的内存空间、系统资源和执行状态。可以将进程看作是一个具有独立资源的程序实例，- 进程间是相互隔离的，彼此无法直接访问对方的内存空间。
* 特点
  - 独立性：进程之间有独立的地址空间，互相之间不能直接访问。
  - 资源拥有：每个进程拥有独立的资源，如内存、文件句柄等。
  - 通信：进程之间的通信需要通过特定的机制（如管道、共享内存、消息队列等）进行，称为进程间通信（IPC）。
  - 开销较大：由于进程有独立的内存空间和资源管理，创建和销毁进程的开销较大。
* 进程的生命周期：
  - 创建：操作系统为进程分配资源，进行初始化。
  - 执行：进程处于运行状态，执行程序中的指令。
  - 阻塞/等待：进程因某些事件（如 I/O 操作）而进入阻塞状态，等待资源或事件完成。
  - 结束：进程执行完成或被终止，操作系统回收其资源。
* 进程的管理：
  - 操作系统通过调度算法控制进程的执行顺序，不同的进程会按优先级、时间片等策略交替执行。
* 多进程
  - 多进程是指在操作系统中同时运行多个进程，每个进程都有自己独立的内存空间，相互之间不受影响。
  - 多进程适合用于CPU密集型任务，如计算密集型算法、图像处理等，因为多进程可以利用多核CPU并行执行任务，提高整体运算速度。
* 进程池
  - 进程池类似于线程池，不同之处在于进程池预先创建一定数量的进程并维护这些进程，以便在需要时重复使用它们。
  - 进程池可以利用多核CPU并行执行任务，提高整体运算速度。

## 线程（Thread）
* 概念
  - 线程是操作系统调度的最小单位，每个进程至少有一个主线程，也可以有多个子线程
  - 线程是共享进程资源的执行单元,线程间共享进程的内存空间和资源，但每个线程有自己的寄存器、栈等执行状态
* 线程的特点：
  - 轻量级：线程共享进程的内存和资源，因此创建、销毁线程的开销相对较小。
  - 共享资源：线程共享进程的内存空间和文件句柄等资源，但每个线程有独立的栈和寄存器。
  - 并发性：线程可以并发执行，多个线程可以在同一个进程内独立执行不同的任务。
  - 上下文切换快：线程切换的上下文较小，开销较低，效率比进程切换高。
* 线程的生命周期：
  - 创建：线程由进程创建，并分配一个线程控制块（TCB）。
  - 就绪：线程准备好执行，但尚未获得 CPU 时间。
  - 运行：线程获得 CPU 时间并正在执行。
  - 阻塞/等待：线程因 I/O 操作、同步操作等原因进入阻塞状态。
  - 结束：线程执行完毕或被终止，操作系统回收线程资源。
* 多线程
  - 多线程是指在同一进程内，多个线程并发执行。
  - 每个线程都拥有自己的执行栈和局部变量，但共享进程的全局变量、静态变量等资源。
  - 多线程适合用于I/O密集型任务，如网络请求、文件操作等，
* 线程池
  - 线程池是一种预先创建一定数量的线程并维护这些线程，以便在需要时重复使用它们的技术。
  - 线程池可以减少线程创建和销毁的开销，提高线程的重复利用率

## 池的对比
* 线程池的优势
  - 轻量级: 线程比进程更轻量级，创建和销毁线程的开销比创建和销毁进程要小。
  - 共享内存: 线程共享同一进程的内存空间，可以方便地共享数据。
  - 低开销: 在切换线程时，线程只需保存和恢复栈和寄存器的状态，开销较低。
* 进程池的优势
  - 真正的并行: 进程可以利用多核CPU真正并行执行任务，而线程受到GIL的限制，在多核CPU上无法真正并行执行。
  - 稳定性: 进程之间相互独立，一个进程崩溃不会影响其他进程，提高了程序的稳定性。
  - 资源隔离: 每个进程有自己独立的内存空间，可以避免多个线程之间的内存共享问题。

## 应用场景
* 多进程：指操作系统同时运行多个进程，它们各自独立执行，不共享内存空间。适合需要隔离性、容错性较高的场景。
* 多线程：同一个进程中并发运行多个线程，它们共享同一块内存空间。适合需要高并发、低延迟、资源共享的场景。如用于计算密集型或 I/O 密集型的任务

## Linux中进程管理
* 进程的控制命令
  - ps| pstree 提供了进程的一次性的查看,它所提供的查看结果并不动态连续的
    ```bash
        # a 显示一个终端的所有进程，除会话引线外；
        # u：显示进程的归属用户及内存的使用情况；
        # x：显示没有控制终端的进程；

        # 列出全部进程信息
        # a 表示显示所有用户的进程，u 显示详细的用户信息，x 显示没有控制终端的进程。
        ps aux

        # 类似于 ps aux，但格式不同。
        # -e 显示全部的进程
        # -f 以完全格式化的形式展示信息
        ps -ef

        ps -u <用户名>： # 显示指定用户的所有进程。
        ps -p <PID>：   # 显示指定 PID 的进程信息。
        ps -ejH         # 来显示进程树

        # 过滤并获得包含 node 在内的所有进程
        ps -ef | grep node 

        ps aux --sort=-%mem： # 按内存使用量降序排列显示所有进程。
        ps aux --sort=-%cpu： # 按 CPU 使用量降序排列显示所有进程。
        
        # 查看线程
        ps -eLf | more
        
        # 关闭进程 -9 表示强制关闭
        kill -9 进程id  
    ```
    
  - top:动态查看进程信息,可以用来监控系统的资源使用情况（如 CPU、内存、磁盘等）。 默认每5s刷新一次
    ```bash
      # PID: 进程ID
      # PPID 该进程的父进程编号

      # UID	执行该进程的用户ID
      # USER: 进程所属的用户
      # PR: 进程优先级
      # NI: 进程的nice值

      # TTY	进程相关的终端类型
      # S: 进程状态（S：睡眠，R：运行，Z：僵尸等）

      # %CPU: 进程占用的 CPU 百分比
      # %MEM: 进程占用的内存百分比
      # VIRT: 进程使用的虚拟内存
      # RES: 进程使用的物理内存
      # SHR: 共享内存

      # TIME+: 进程使用的总 CPU 时间
      # COMMAND: 进程名称或命令

      top # 实时更新的方式显示当前系统中各个进程的详细信息

      # 常用命令
      # -p 只显示某个进程的信息 -i 不显示任何闲置的进程
      top -d <秒数>:   # 设置更新间隔时间（单位为秒）。
      top -u <用户名>:  # 显示某个用户的进程。
      top -p <pid1>,<pid2>,...: # 只显示特定进程的状态。
      top -b:         # 以批处理模式运行，适合输出到文件。

      # 在 top 中的一些快捷键：
      #  M：按内存使用量排序。
      #  P：按 CPU 使用量排序。
      #  q：退出 top 命令。
      #  h：显示帮助信息。
    ```
* 服务管理工具
  > 控制服务启动。停止、开启
  ```bash
    # 开机自启动 如防火墙
    systemctl enable firewalld 
    # 关闭开机自启动
    systemctl disable firewalld 
  ```  